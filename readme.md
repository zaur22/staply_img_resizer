# Staply Img resizer

## Что делает?
Сервис для создания миниатюрок из изображений. Может принимать изображение в трёх форматах
+ multipart/form-data в форме с названием "image"
+ строку base64 в JSON в поле с названием "image"
+ ссылку на изображение из сети как GET параметр с названием "url"

примеры запросов можно посмотреть в makefile


## Как устроен?
Процесс устроен в виде пайплайна воркеров. Есть три типо воркеров:
+ requestImg, которые занимают загрузкой из сети.
+ resize, которые занимаются ресайзом. 
+ fileSave, которые сохраняют созданные изображения.

Между собой они общаются через каналлы.

Идея в том, чтобы путём подбора количества воркеров для каждой задачи, в зависимости от машины и статистики заросов, обеспечить максимальную производительность системы.

Сам ресайзинг происходит с помощью утлиты [vips](https://jcupitt.github.io/libvips/) в который так же выполняет задачи многопоточно и который так же можно настраивать.

## Конфиги
Пример настройки можно посмотреть в файле [compose](https://github.com/zaur22/staply_img_resizer/blob/master/docker-compose.yml)

Полный список всех конфигов можно посмотреть в файле [config.go](https://github.com/zaur22/staply_img_resizer/blob/master/config/config.go)

Прим.: Названия Envirenment конфигов нужно вводить строго в заглавном виде.


## Производительность
Мой ноутбук
ubuntu 64 bit
Intel(R) Core(TM) i5-3210M CPU @ 2.50GHz
ОЗУ 6 GB
Samsung SSD 860

[Бэнчмарк](https://github.com/zaur22/staply_img_resizer/blob/master/resizer/resizer_test.go#L68) выдаёт в 70 мс в среднем на ресайз и сохранение одного изображения

BenchmarkResizeAndSaveConcurency-4   	     200	  73735635 ns/op	 8394119 B/op	      56 allocs/op


## Что можно сделать ещё?
+ Провести профилирование через pprof
+ Добавить cli интерфейс
+ Поддержку s3
+ Ограничения по форматам изображений
+ и т.п.